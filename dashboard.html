<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px;
        }

        .status-running {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .status-error {
            background: #f44336;
            animation: blink 1s infinite;
        }

        .status-warning {
            background: #ff9800;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #b3d9ff;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .confidence-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa00 50%, #44ff44 100%);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .action-display {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .action-buy {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .action-sell {
            background: linear-gradient(45deg, #f44336, #da190b);
        }

        .action-hold {
            background: linear-gradient(45deg, #ff9800, #e68900);
        }

        .logs-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .logs-container {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-info {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
        }

        .log-error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #f44336;
        }

        .log-warning {
            background: rgba(255, 152, 0, 0.2);
            border-left: 3px solid #ff9800;
        }

        .log-success {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        .timestamp {
            opacity: 0.7;
            font-size: 0.8rem;
        }

        .price-change {
            font-size: 1rem;
            margin-top: 5px;
        }

        .price-up {
            color: #4CAF50;
        }

        .price-down {
            color: #f44336;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ðŸ¤– Agent Trading Dashboard</h1>
            <div>
                <span id="systemStatus" class="status-indicator status-running">System Running</span>
                <span class="timestamp">Last Updated: <span id="lastUpdate">--:--:--</span></span>
                <span class="timestamp" id="dataSource" style="margin-left: 15px;">Data: Loading...</span>
            </div>
        </div>

        <div class="metrics-grid">
            <!-- BTC Price Card -->
            <div class="metric-card">
                <div class="metric-title">Bitcoin Price (BTCUSDT)</div>
                <div class="metric-value" id="btcPrice">$--,---</div>
                <div class="price-change" id="priceChange">-- (---%)</div>
                <div class="metric-subtitle">Real-time Binance Feed</div>
            </div>

            <!-- Current Action Card -->
            <div class="metric-card">
                <div class="metric-title">Current Trading Action</div>
                <div class="action-display action-hold" id="currentAction">INITIALIZING</div>
                <div class="metric-subtitle">Last Decision: <span id="lastDecisionTime">--:--:--</span></div>
            </div>

            <!-- Confidence Level Card -->
            <div class="metric-card">
                <div class="metric-title">Decision Confidence</div>
                <div class="metric-value" id="confidenceValue">--%</div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                </div>
                <div class="metric-subtitle">AI Analysis Certainty</div>
            </div>

            <!-- System Health Card -->
            <div class="metric-card">
                <div class="metric-title">System Health</div>
                <div class="metric-value" id="systemHealth">Checking...</div>
                <div class="metric-subtitle">
                    <div>Uptime: <span id="uptime">00:00:00</span></div>
                    <div>Cycles: <span id="totalCycles">0</span></div>
                </div>
            </div>

            <!-- Performance Card -->
            <div class="metric-card">
                <div class="metric-title">Performance</div>
                <div class="metric-value" id="performance">+0.00%</div>
                <div class="metric-subtitle">
                    <div>P&L: $<span id="pnl">0.00</span></div>
                    <div>Win Rate: <span id="winRate">--%</span></div>
                </div>
            </div>

            <!-- Risk Metrics Card -->
            <div class="metric-card">
                <div class="metric-title">Risk Metrics</div>
                <div class="metric-value" id="riskLevel">LOW</div>
                <div class="metric-subtitle">
                    <div>VaR: $<span id="var">--</span></div>
                    <div>Max Drawdown: <span id="maxDrawdown">--%</span></div>
                </div>
            </div>

            <!-- Physics Risk Analysis Card -->
            <div class="metric-card" style="grid-column: span 2;">
                <div class="metric-title">ðŸ”¬ Physics-Based Risk Analysis</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                    <div>
                        <div class="metric-subtitle" style="color: #ffcc80;">Information Entropy</div>
                        <div class="metric-value" style="font-size: 1.5rem;" id="entropyRisk">--.--</div>
                        <div class="metric-subtitle">Market Uncertainty</div>
                    </div>
                    <div>
                        <div class="metric-subtitle" style="color: #81c784;">Hurst Exponent</div>
                        <div class="metric-value" style="font-size: 1.5rem;" id="hurstExponent">--.--</div>
                        <div class="metric-subtitle">Memory/Trauma Detection</div>
                    </div>
                    <div>
                        <div class="metric-subtitle" style="color: #e57373;">Lyapunov Instability</div>
                        <div class="metric-value" style="font-size: 1.5rem;" id="lyapunovInstability">--.--</div>
                        <div class="metric-subtitle">System Chaos Level</div>
                    </div>
                    <div>
                        <div class="metric-subtitle" style="color: #ba68c8;">Regime Transition</div>
                        <div class="metric-value" style="font-size: 1.5rem;" id="regimeTransition">--.--</div>
                        <div class="metric-subtitle">Market State Change</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div class="metric-subtitle">Physics Risk Summary: <span id="physicsRiskSummary" style="font-weight: bold;">Analyzing...</span></div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="logs-section">
            <div class="logs-header">
                <h2>ðŸ“‹ System Logs</h2>
                <div class="auto-refresh">
                    <span>Auto-refresh</span>
                    <label class="switch">
                        <input type="checkbox" id="autoRefresh" checked>
                        <span class="slider"></span>
                    </label>
                    <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh</button>
                </div>
            </div>
            <div class="logs-container" id="logsContainer">
                <div class="log-entry log-info">
                    <span class="timestamp">[00:00:00]</span> Dashboard initialized. Waiting for trading system data...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dashboard state
        let dashboardData = {
            btcPrice: 0,
            priceChange: 0,
            currentAction: 'HOLD',
            confidence: 0,
            systemHealth: 'HEALTHY',
            uptime: 0,
            totalCycles: 0,
            performance: 0,
            pnl: 0,
            winRate: 0,
            riskLevel: 'LOW',
            var: 0,
            maxDrawdown: 0,
            logs: [],
            // Physics-based risk metrics
            physicsRisk: {
                entropyRisk: 0,
                hurstExponent: 0.5,
                lyapunovInstability: 0,
                regimeTransition: 0,
                riskSummary: 'Normal'
            }
        };

        let startTime = Date.now();
        let autoRefreshInterval;

        // Initialize dashboard
        function initDashboard() {
            updateLastUpdateTime();
            startAutoRefresh();
            
            // Try to load real data first, fallback to mock data
            loadRealData();
        }

        // Load real data from API endpoints
        function loadRealData() {
            fetchDashboardData();
        }

        // Fetch all dashboard data from API
        function fetchDashboardData() {
            // Fetch main dashboard data
            fetch('/api/dashboard')
                .then(response => response.json())
                .then(data => {
                    // Update dashboard data from API response
                    dashboardData = {
                        // Price data
                        btcPrice: data.price?.btcPrice || 0,
                        priceChange: data.price?.priceChange || 0,
                        
                        // Decision data
                        currentAction: data.decision?.currentAction || 'HOLD',
                        confidence: data.decision?.confidence || 0,
                        lastDecisionTime: data.decision?.lastDecisionTime || new Date().toISOString(),
                        
                        // System status
                        systemHealth: data.status?.systemHealth || 'UNKNOWN',
                        uptime: (data.status?.uptime || 0) * 1000, // Convert to milliseconds
                        
                        // Performance data
                        totalCycles: data.performance?.totalCycles || 0,
                        performance: data.performance?.performance || 0,
                        pnl: data.performance?.pnl || 0,
                        winRate: data.performance?.winRate || 0,
                        riskLevel: data.performance?.riskLevel || 'LOW',
                        var: data.performance?.var || 0,
                        maxDrawdown: data.performance?.maxDrawdown || 0,
                        
                        // Logs
                        logs: data.logs || [],
                        
                        // Physics risk (will be updated separately)
                        physicsRisk: dashboardData.physicsRisk,
                        
                        // Data source info
                        dataSource: {
                            price: data.price?.source || 'unknown',
                            decision: data.decision?.source || 'unknown',
                            performance: data.performance?.source || 'unknown',
                            status: data.status?.source || 'unknown'
                        }
                    };
                    
                    updateDashboard();
                })
                .catch(error => {
                    console.error('Error fetching dashboard data:', error);
                    addErrorLog('Failed to fetch dashboard data from API');
                    // Fall back to mock data if API fails
                    loadMockData();
                });

            // Fetch physics risk data separately
            fetch('/api/physics-risk')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        dashboardData.physicsRisk = {
                            entropyRisk: data.entropy_risk || 0,
                            hurstExponent: data.hurst_exponent || 0.5,
                            lyapunovInstability: data.lyapunov_instability || 0,
                            regimeTransition: data.regime_transition_probability || 0,
                            riskSummary: data.risk_summary || 'Normal'
                        };
                        updatePhysicsDisplay();
                    }
                })
                .catch(error => {
                    console.log('Physics risk data not available, using defaults');
                    // Keep default physics risk values
                });
        }

        // Load mock data as fallback
        function loadMockData() {
            dashboardData = {
                btcPrice: 43250.75,
                priceChange: 1.25,
                currentAction: 'HOLD',
                confidence: 65,
                systemHealth: 'HEALTHY',
                uptime: Date.now() - startTime,
                totalCycles: 42,
                performance: 2.34,
                pnl: 234.50,
                winRate: 68,
                riskLevel: 'MEDIUM',
                var: 1500,
                maxDrawdown: 3.2,
                logs: [
                    { type: 'warning', message: 'Using mock data - API not available', timestamp: new Date() },
                    { type: 'info', message: 'Dashboard initialized with fallback data', timestamp: new Date() }
                ],
                physicsRisk: {
                    entropyRisk: 0.65,
                    hurstExponent: 0.47,
                    lyapunovInstability: 0.23,
                    regimeTransition: 0.15,
                    riskSummary: 'Moderate Risk - Market showing signs of instability'
                }
            };
            updateDashboard();
        }

        // Add error log to display
        function addErrorLog(message) {
            dashboardData.logs.unshift({
                type: 'error',
                message: message,
                timestamp: new Date()
            });
            updateLogs();
        }

        // Update dashboard UI
        function updateDashboard() {
            // BTC Price
            document.getElementById('btcPrice').textContent = `$${dashboardData.btcPrice.toLocaleString()}`;
            
            const priceChangeEl = document.getElementById('priceChange');
            const changeText = `${dashboardData.priceChange > 0 ? '+' : ''}${dashboardData.priceChange.toFixed(2)}%`;
            priceChangeEl.textContent = changeText;
            priceChangeEl.className = `price-change ${dashboardData.priceChange > 0 ? 'price-up' : 'price-down'}`;

            // Current Action
            const actionEl = document.getElementById('currentAction');
            actionEl.textContent = dashboardData.currentAction;
            actionEl.className = `action-display action-${dashboardData.currentAction.toLowerCase()}`;

            // Confidence
            document.getElementById('confidenceValue').textContent = `${dashboardData.confidence}%`;
            document.getElementById('confidenceFill').style.width = `${dashboardData.confidence}%`;

            // System Health
            document.getElementById('systemHealth').textContent = dashboardData.systemHealth;
            
            // Update system status indicator
            const statusEl = document.getElementById('systemStatus');
            if (dashboardData.systemHealth === 'HEALTHY') {
                statusEl.className = 'status-indicator status-running';
                statusEl.textContent = 'System Running';
            } else {
                statusEl.className = 'status-indicator status-error';
                statusEl.textContent = 'System Issues';
            }

            // Uptime
            const uptimeSeconds = Math.floor(dashboardData.uptime / 1000);
            const hours = Math.floor(uptimeSeconds / 3600);
            const minutes = Math.floor((uptimeSeconds % 3600) / 60);
            const seconds = uptimeSeconds % 60;
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Other metrics
            document.getElementById('totalCycles').textContent = dashboardData.totalCycles;
            document.getElementById('performance').textContent = `${dashboardData.performance > 0 ? '+' : ''}${dashboardData.performance.toFixed(2)}%`;
            document.getElementById('pnl').textContent = dashboardData.pnl.toFixed(2);
            document.getElementById('winRate').textContent = `${dashboardData.winRate}%`;
            document.getElementById('riskLevel').textContent = dashboardData.riskLevel;
            document.getElementById('var').textContent = dashboardData.var.toLocaleString();
            document.getElementById('maxDrawdown').textContent = `${dashboardData.maxDrawdown}%`;

            // Update physics display
            updatePhysicsDisplay();

            // Update logs
            updateLogs();
            updateLastUpdateTime();
            updateDataSourceIndicator();
        }

        // Update physics-based risk display
        function updatePhysicsDisplay() {
            const physics = dashboardData.physicsRisk;
            
            // Update entropy risk (0-1 scale, higher = more uncertain)
            document.getElementById('entropyRisk').textContent = physics.entropyRisk.toFixed(3);
            
            // Update Hurst exponent (0-1 scale, <0.5 = mean reverting, >0.5 = trending)
            document.getElementById('hurstExponent').textContent = physics.hurstExponent.toFixed(3);
            
            // Update Lyapunov instability (higher = more chaotic)
            document.getElementById('lyapunovInstability').textContent = physics.lyapunovInstability.toFixed(3);
            
            // Update regime transition probability (0-1 scale)
            document.getElementById('regimeTransition').textContent = physics.regimeTransition.toFixed(3);
            
            // Update risk summary
            document.getElementById('physicsRiskSummary').textContent = physics.riskSummary;
            
            // Color-code the summary based on risk level
            const summaryEl = document.getElementById('physicsRiskSummary');
            if (physics.riskSummary.toLowerCase().includes('high') || 
                physics.riskSummary.toLowerCase().includes('critical') ||
                physics.lyapunovInstability > 0.5) {
                summaryEl.style.color = '#f44336'; // Red
            } else if (physics.riskSummary.toLowerCase().includes('moderate') || 
                       physics.entropyRisk > 0.7 || 
                       physics.regimeTransition > 0.3) {
                summaryEl.style.color = '#ff9800'; // Orange
            } else {
                summaryEl.style.color = '#4CAF50'; // Green
            }
        }

        // Update logs display
        function updateLogs() {
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.innerHTML = '';

            const logsToShow = dashboardData.logs.slice(-10).reverse();
            
            logsToShow.forEach(log => {
                const logEl = document.createElement('div');
                logEl.className = `log-entry log-${log.type}`;
                
                // Handle both string timestamps and Date objects
                let timestamp;
                if (log.timestamp instanceof Date) {
                    timestamp = log.timestamp.toLocaleTimeString();
                } else {
                    timestamp = new Date(log.timestamp).toLocaleTimeString();
                }
                
                logEl.innerHTML = `
                    <span class="timestamp">[${timestamp}]</span> ${log.message}
                `;
                
                logsContainer.appendChild(logEl);
            });
            
            // If no logs, show placeholder
            if (logsToShow.length === 0) {
                const placeholderEl = document.createElement('div');
                placeholderEl.className = 'log-entry log-info';
                placeholderEl.innerHTML = `
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span> 
                    Waiting for system logs...
                `;
                logsContainer.appendChild(placeholderEl);
            }
        }

        // Refresh data (now uses real API calls)
        function refreshData() {
            console.log('Refreshing dashboard data from API...');
            fetchDashboardData();
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            
            function updateAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                
                if (autoRefreshCheckbox.checked) {
                    autoRefreshInterval = setInterval(refreshData, 5000); // Refresh every 5 seconds
                }
            }
            
            autoRefreshCheckbox.addEventListener('change', updateAutoRefresh);
            updateAutoRefresh();
        }

        // Update last update time
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Update data source indicator
        function updateDataSourceIndicator() {
            const dataSourceEl = document.getElementById('dataSource');
            if (dashboardData.dataSource) {
                const sources = dashboardData.dataSource;
                let indicator = 'Data: ';
                
                if (sources.price === 'live_trading_system' || 
                    sources.decision === 'live_trading_system' || 
                    sources.performance === 'live_trading_system') {
                    indicator += 'ðŸŸ¢ Live System';
                } else if (sources.price === 'file_based' || 
                          sources.decision === 'file_based' || 
                          sources.performance === 'file_based') {
                    indicator += 'ðŸŸ¡ File Based';
                } else {
                    indicator += 'ðŸ”´ Mock Data';
                }
                
                dataSourceEl.textContent = indicator;
            } else {
                dataSourceEl.textContent = 'Data: Unknown';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);

        // TODO: Replace mock data with actual API endpoints
        // Example API endpoints you'll need to create:
        // 
        // GET /api/status - System health and status
        // GET /api/price - Current BTC price and change
        // GET /api/decision - Latest trading decision and confidence
        // GET /api/performance - Performance metrics
        // GET /api/logs - Recent system logs
        // 
        // function fetchRealData() {
        //     Promise.all([
        //         fetch('/api/status').then(r => r.json()),
        //         fetch('/api/price').then(r => r.json()),
        //         fetch('/api/decision').then(r => r.json()),
        //         fetch('/api/performance').then(r => r.json()),
        //         fetch('/api/logs').then(r => r.json())
        //     ]).then(([status, price, decision, performance, logs]) => {
        //         dashboardData = {
        //             ...dashboardData,
        //             ...status,
        //             ...price,
        //             ...decision,
        //             ...performance,
        //             logs: logs
        //         };
        //         updateDashboard();
        //     }).catch(console.error);
        // }
    </script>
</body>
</html>
